<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tablero Ãgil â€” Semana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    input[type="range"] { appearance: none; height: 6px; border-radius: 5px; background: linear-gradient(to right, #f87171 0%, #facc15 50%, #4ade80 100%); outline: none; }
    input[type="range"]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; border-radius: 50%; background: white; border: 2px solid #3b82f6; cursor: pointer; }
    .drag-over { background-color: #e0f2fe !important; border: 2px dashed #3b82f6 !important; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-7xl mx-auto py-6 px-4">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">ğŸ“… Tablero Ãgil â€” Semana</h1>
      <div class="space-x-2">
        <button id="importBtn" class="px-3 py-1 bg-gray-200 rounded text-sm font-semibold">â¬†ï¸ Importar JSON</button>
        <input type="file" id="importFile" class="hidden" accept="application/json">
        <button id="exportBtn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm font-semibold">â¬‡ï¸ Exportar JSON</button>
      </div>
    </header>

    <div class="mb-4 flex flex-wrap gap-2">
      <button class="tab-btn px-4 py-1 bg-blue-500 text-white rounded shadow-sm" data-tab="today">Hoy</button>
      <button class="tab-btn px-4 py-1 bg-gray-200 rounded shadow-sm" data-tab="week">Semana</button>
      <button class="tab-btn px-4 py-1 bg-gray-200 rounded shadow-sm" data-tab="report">Reporte / Sincro IA</button>
      <button class="tab-btn px-4 py-1 bg-gray-200 rounded shadow-sm" data-tab="team">Equipo</button>
    </div>

    <div id="tab-today" class="tab-content">
      <div id="todayHighlight" class="mb-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 font-semibold rounded shadow-sm">
        Highlight: <span id="highlightText">(sin definir)</span>
      </div>
      <div id="todayTasks" class="space-y-2"></div>
      
      <h3 class="mt-8 font-bold text-gray-700">â• Nueva Tarea</h3>
      <div class="flex flex-col md:flex-row gap-2 mt-2 p-4 bg-white rounded-lg shadow border">
        <input id="newTodayTask" type="text" placeholder="Â¿QuÃ© hay que hacer?" class="flex-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-300 outline-none">
        <select id="newTodayPriority" class="px-2 py-2 border rounded text-sm font-medium bg-gray-50">
          <option value="alta">ğŸ”´ Alta (Hoy)</option>
          <option value="media" selected>ğŸŸ¡ Media (MaÃ±ana)</option>
          <option value="baja">ğŸŸ¢ Baja (Backlog)</option>
        </select>
        <select id="newTodayObjective" class="px-2 py-2 border rounded text-sm bg-gray-50"></select>
        <button onclick="addTodayNew()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 transition-all">Agregar</button>
      </div>
    </div>

    <div id="tab-week" class="tab-content hidden">
      <div id="weekTasks" class="grid grid-cols-1 md:grid-cols-6 gap-4"></div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
        <div class="bg-white p-4 rounded-lg border shadow-sm">
          <h3 class="font-bold text-blue-600 mb-2 uppercase text-xs tracking-wider">ğŸ“Œ Temas para Staff</h3>
          <div class="flex gap-2 mb-4"><input id="newStaffTopic" class="flex-1 border rounded px-2 py-1 text-sm"><button onclick="addTopic('staffTopics')" class="bg-blue-500 text-white px-3 rounded text-sm">Add</button></div>
          <div id="staffTopicsList" class="space-y-2"></div>
        </div>
        <div class="bg-white p-4 rounded-lg border shadow-sm">
          <h3 class="font-bold text-purple-600 mb-2 uppercase text-xs tracking-wider">ğŸ‘¤ Temas para 1:1</h3>
          <div class="flex gap-2 mb-4"><input id="newOneToOne" class="flex-1 border rounded px-2 py-1 text-sm"><button onclick="addTopic('oneToOneTopics')" class="bg-purple-500 text-white px-3 rounded text-sm">Add</button></div>
          <div id="oneToOneList" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <div id="tab-report" class="tab-content hidden">
      <div id="reportLog" class="space-y-3 mb-10"></div>
      <div class="p-6 bg-indigo-50 border-2 border-indigo-200 rounded-2xl shadow-inner">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-indigo-800 font-black flex items-center gap-2">ğŸ¤– SINCRONIZACIÃ“N INTELIGENTE (LLEVAR A LM)</h3>
            <span class="bg-indigo-200 text-indigo-700 px-2 py-0.5 rounded-full text-[10px] font-bold">MERGE ACTIVO</span>
        </div>
        <p class="text-xs text-indigo-600 mb-4">Pega el JSON de la IA. El sistema <strong>sumarÃ¡</strong> lo nuevo a tus tareas actuales sin borrar nada.</p>
        <textarea id="iaInput" class="w-full h-40 p-4 text-xs font-mono border-2 border-indigo-100 rounded-xl mb-4 shadow-sm outline-none focus:border-indigo-400" placeholder='{ "week": { ... } }'></textarea>
        <button onclick="importFromIA()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg active:scale-[0.98] transition-all">
            ğŸ”„ INTEGRAR DATOS DE IA
        </button>
      </div>
    </div>

    <div id="tab-team" class="tab-content hidden"><div id="teamTasks" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-12 border-t pt-8">
      <div class="bg-white p-4 rounded-xl shadow-sm border text-center"><div class="text-3xl font-black text-blue-600" id="kpiTotal">0</div><div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Tareas</div></div>
      <div class="bg-white p-4 rounded-xl shadow-sm border text-center"><div class="text-3xl font-black text-green-600" id="kpiCompletadas">0</div><div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Hechas</div></div>
      <div class="bg-white p-4 rounded-xl shadow-sm border text-center"><div class="text-3xl font-black text-yellow-500" id="kpiAtrasadas">0</div><div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Atrasadas</div></div>
      <div class="bg-white p-4 rounded-xl shadow-sm border text-center"><div class="text-3xl font-black text-purple-600" id="kpiPct">0%</div><div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Score</div></div>
    </div>
  </div>

  <div id="finalNoteModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[10000] backdrop-blur-sm">
    <div class="bg-white rounded-2xl p-8 w-[450px] shadow-2xl">
      <h2 class="font-black text-xl mb-1 text-gray-800">âœ… Cerrar Tarea</h2>
      <p id="finalNoteTaskTitle" class="text-sm text-gray-400 mb-6 italic"></p>
      <textarea id="finalNoteInput" class="w-full border-2 border-gray-100 rounded-xl p-4 h-32 mb-6 outline-none focus:border-green-400 text-sm" placeholder="Â¿QuÃ© se concluyÃ³?"></textarea>
      <div class="flex justify-end gap-3">
        <button onclick="closeFinalNoteModal()" class="px-4 py-2 text-gray-400 font-bold">Cancelar</button>
        <button onclick="saveFinalNote()" class="px-6 py-2 bg-green-500 text-white font-black rounded-xl hover:bg-green-600 transition-all">GUARDAR Y ARCHIVAR</button>
      </div>
    </div>
  </div>

  <script>
    let data = {
      categories: ["Administrativas", "General", "Makro", "Windows 11", "TFM", "Software Selection", "licenciamiento"],
      contextHistory: [],
      week: { Mon: [], Tue: [], Wed: [], Thu: [], Fri: [], Next: [], Backlog: [] },
      staffTopics: [], oneToOneTopics: [], history: [], historyTasks: [],
      dailyHighlights: { Mon: null, Tue: null, Wed: null, Thu: null, Fri: null }
    };

    function renderAll() {
      renderCategorySelects();
      renderToday();
      renderWeek();
      renderTopics();
      renderReport();
      renderKpis();
    }

    // --- MERGE INTELIGENTE (LA CLAVE) ---
    function importFromIA() {
      const input = document.getElementById("iaInput");
      try {
        const newData = JSON.parse(input.value);
        
        // 1. Unir CategorÃ­as (sin duplicar)
        if(newData.categories) {
            data.categories = [...new Set([...data.categories, ...newData.categories])];
        }

        // 2. Unir ContextHistory
        if(newData.contextHistory) {
            data.contextHistory = [...newData.contextHistory, ...data.contextHistory].slice(0, 50);
        }

        // 3. Unir Semanas (DÃ­a por dÃ­a, sin duplicar IDs)
        const daysKeys = ["Mon", "Tue", "Wed", "Thu", "Fri", "Next", "Backlog"];
        daysKeys.forEach(day => {
            if (newData.week && newData.week[day]) {
                newData.week[day].forEach(newTask => {
                    const exists = data.week[day].some(t => t.id === newTask.id);
                    if (!exists) data.week[day].push(newTask);
                });
            }
        });

        // 4. Unir Topics
        if(newData.staffTopics) data.staffTopics = [...new Set([...data.staffTopics, ...newData.staffTopics])];

        saveData();
        renderAll();
        input.value = "";
        alert("ğŸš€ SincronizaciÃ³n exitosa: Se sumaron los nuevos datos sin borrar los anteriores.");
      } catch (e) {
        alert("âŒ Error: El texto no es un JSON vÃ¡lido.");
      }
    }

    function renderToday() {
      const dayMap = [null, "Mon", "Tue", "Wed", "Thu", "Fri"];
      const todayKey = dayMap[new Date().getDay()] || "Mon";
      const container = document.getElementById("todayTasks");
      container.innerHTML = "";

      const todayTasks = data.week[todayKey] || [];
      const highlightId = data.dailyHighlights[todayKey];

      todayTasks.forEach(t => {
        const isH = t.id === highlightId;
        container.innerHTML += `
          <div class="p-4 bg-white rounded-xl shadow-sm border mb-3 flex justify-between items-center group hover:shadow-md transition-all ${t.priority === 'alta' ? 'border-l-4 border-l-red-500' : ''}">
            <div class="flex-1">
              <div class="text-sm font-black text-gray-800">${t.title}</div>
              <div class="flex gap-4 mt-2">
                <button onclick="openValModal('${t.id}', 'impact')" class="text-[10px] font-bold uppercase tracking-tighter ${t.impactExplanation ? 'text-blue-600' : 'text-gray-300 underline'}">ğŸŒŸ Impacto</button>
                <button onclick="openValModal('${t.id}', 'urgency')" class="text-[10px] font-bold uppercase tracking-tighter ${t.urgencyExplanation ? 'text-orange-500' : 'text-gray-300 underline'}">â° Urgencia</button>
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">ğŸ¯ ${t.objective}</span>
              </div>
            </div>
            <div class="flex items-center gap-3">
               <input type="number" value="${t.progress}" onchange="updateTaskProgress('${todayKey}','${t.id}',this.value)" class="w-12 h-8 text-center font-bold border rounded-lg bg-gray-50">
               <button onclick="toggleHighlight('${todayKey}','${t.id}')" class="text-xl ${isH ? 'text-yellow-400' : 'text-gray-200'} group-hover:scale-110 transition-transform">â˜…</button>
            </div>
          </div>`;
      });
      document.getElementById("highlightText").innerText = todayTasks.find(x => x.id === highlightId)?.title || "(sin definir)";
    }

    function addTodayNew() {
      const title = document.getElementById("newTodayTask").value.trim();
      if (!title) return;
      const priority = document.getElementById("newTodayPriority").value;
      const objective = document.getElementById("newTodayObjective").value;
      const dayMap = [null, "Mon", "Tue", "Wed", "Thu", "Fri"];
      const todayKey = dayMap[new Date().getDay()] || "Mon";

      const newTask = { id: crypto.randomUUID(), title, priority, objective, progress: 0, assignedAt: new Date().toISOString().split('T')[0] };
      
      if(priority === 'alta') data.week[todayKey].push(newTask);
      else if(priority === 'media') data.week[dayMap[(new Date().getDay() % 5) + 1] || "Next"].push(newTask);
      else data.week.Backlog.push(newTask);

      document.getElementById("newTodayTask").value = "";
      saveData(); renderAll();
    }

    function updateTaskProgress(day, id, val) {
      const task = data.week[day].find(t => t.id === id);
      task.progress = parseInt(val) || 0;
      if(task.progress >= 100) {
        currentTaskRef = { day, id };
        document.getElementById("finalNoteTaskTitle").innerText = task.title;
        document.getElementById("finalNoteModal").classList.replace("hidden", "flex");
      }
      saveData(); renderToday();
    }

    let currentTaskRef = null;
    function saveFinalNote() {
      const note = document.getElementById("finalNoteInput").value;
      const { day, id } = currentTaskRef;
      const idx = data.week[day].findIndex(t => t.id === id);
      const [task] = data.week[day].splice(idx, 1);
      task.finalNote = note; task.closedAt = new Date().toISOString().split('T')[0];
      data.historyTasks.push(task);
      document.getElementById("finalNoteModal").classList.replace("flex", "hidden");
      saveData(); renderAll();
    }

    function openValModal(id, field) {
        const d = findTask(id);
        const current = d.task[field + 'Explanation'] || "";
        const val = prompt(`Definir ${field.toUpperCase()}:`, current);
        if(val !== null) { d.task[field + 'Explanation'] = val; saveData(); renderToday(); }
    }

    function findTask(id) {
        for(let d in data.week) {
            const t = data.week[d].find(x => x.id === id);
            if(t) return { task: t, day: d };
        }
    }

    function renderWeek() {
        const cont = document.getElementById("weekTasks"); cont.innerHTML = "";
        ["Mon", "Tue", "Wed", "Thu", "Fri", "Next"].forEach(d => {
            cont.innerHTML += `<div class="bg-white p-3 rounded-xl shadow-sm border min-h-[120px]">
                <div class="text-[10px] font-black uppercase text-gray-400 mb-3 border-b pb-1">${d}</div>
                ${(data.week[d] || []).map(t => `<div class="text-[11px] font-bold mb-1 p-2 bg-gray-50 rounded-lg border border-gray-100 truncate">${t.title}</div>`).join("")}
            </div>`;
        });
    }

    function renderReport() {
        document.getElementById("reportLog").innerHTML = data.contextHistory.map(c => `
            <div class="p-4 bg-white rounded-xl border-l-4 border-indigo-500 shadow-sm">
                <div class="text-[10px] font-black text-indigo-300 uppercase">${c.date} | ${c.category}</div>
                <div class="font-bold text-gray-800 text-sm">${c.title}</div>
                <div class="text-xs text-gray-500 italic mt-1">${c.note}</div>
            </div>`).join("");
    }

    function renderKpis() {
        document.getElementById("kpiTotal").innerText = Object.values(data.week).flat().length;
        document.getElementById("kpiCompletadas").innerText = data.historyTasks.length;
    }

    function renderCategorySelects() {
        const html = data.categories.map(c => `<option value="${c}">${c}</option>`).join("");
        document.getElementById("newTodayObjective").innerHTML = html;
    }

    function toggleHighlight(d, id) { data.dailyHighlights[d] = (data.dailyHighlights[d] === id ? null : id); saveData(); renderToday(); }
    function closeFinalNoteModal() { document.getElementById("finalNoteModal").classList.replace("flex", "hidden"); }
    function saveData() { localStorage.setItem("tableroAgilData", JSON.stringify(data)); }
    function addTopic(type) { const v = document.getElementById(type === 'staffTopics' ? "newStaffTopic" : "newOneToOne").value; if(v){ data[type].push({ id: crypto.randomUUID(), text: v }); saveData(); renderTopics(); } }
    function renderTopics() {
        document.getElementById("staffTopicsList").innerHTML = data.staffTopics.map(t => `<div class="text-xs font-bold p-2 bg-blue-50 text-blue-700 rounded-lg border border-blue-100">ğŸ“Œ ${typeof t === 'string' ? t : t.text}</div>`).join("");
        document.getElementById("oneToOneList").innerHTML = data.oneToOneTopics.map(t => `<div class="text-xs font-bold p-2 bg-purple-50 text-purple-700 rounded-lg border border-purple-100">ğŸ‘¤ ${typeof t === 'string' ? t : t.text}</div>`).join("");
    }
    function handleEnter(e, cb) { if(e.key === "Enter") cb(); }

    window.onload = () => {
      const saved = localStorage.getItem("tableroAgilData");
      if (saved) data = JSON.parse(saved);
      renderAll();
    };

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.replace("bg-blue-500", "bg-gray-200"));
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("text-white"));
        btn.classList.replace("bg-gray-200", "bg-blue-500");
        btn.classList.add("text-white");
        document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
        document.getElementById(`tab-${btn.dataset.tab}`).classList.remove("hidden");
      });
    });
  </script>
</body>
</html>
